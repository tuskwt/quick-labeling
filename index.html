<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Label Nama Siap Cetak</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries untuk Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

    <!-- Font Awesome untuk Ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Container Label (Simulasi Kertas Panjang) */
        .sheet {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin: 0 auto 20px auto;
            padding: 10mm; /* Margin default */
            box-sizing: border-box;
            border: 1px solid #e5e7eb;
            position: relative;
            height: auto;
            min-height: 297mm; /* Minimal setinggi A4 agar terlihat bagus */
        }

        /* Lebar berdasarkan Orientasi (Default acuan A4 agar proporsional di layar) */
        .sheet.portrait { width: 210mm; }
        .sheet.landscape { width: 297mm; }

        /* Grid Label */
        .label-grid {
            display: grid;
            gap: 4mm; /* Jarak antar label */
            width: 100%;
        }

        /* Desain Kartu Label */
        .label-card {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            aspect-ratio: 2/1; /* Rasio Lebar:Tinggi = 2:1 */
            background-color: #fff;
            width: 100%;
            /* PENTING: Mencegah kartu terpotong saat ganti halaman di printer */
            break-inside: avoid; 
            page-break-inside: avoid;
        }

        .label-name {
            font-weight: 700;
            color: #1f2937;
            line-height: 1.1;
            word-break: break-word;
        }

        .label-nis {
            margin-top: 4px;
            font-size: 0.8em;
            color: #6b7280;
            font-weight: 500;
        }

        /* PENTING: Pengaturan Print */
        @media print {
            body {
                background: white;
                -webkit-print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }

            #main-content {
                margin: 0;
                padding: 0;
                overflow: visible !important;
            }

            #preview-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .sheet {
                box-shadow: none;
                border: none;
                margin: 0;
                width: 100% !important;
                padding: 0 !important; /* Biarkan margin printer yang mengatur */
                min-height: 0;
            }
            
            .label-card {
                border: 1px solid #000; /* Border solid tipis saat print agar jelas */
            }

            .label-grid {
                gap: 2mm; /* Sedikit rapatkan gap saat print hemat ruang */
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center no-print z-10 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fa-solid fa-tags text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800">SKWT Label Generator</h1>
                <p class="text-xs text-gray-500">Generator Label Massal</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="downloadXLSX()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-md transition flex items-center gap-2">
                <i class="fa-solid fa-file-excel"></i> .xlsx
            </button>
            <button onclick="downloadDOCX()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-md transition flex items-center gap-2">
                <i class="fa-solid fa-file-word"></i> .docx
            </button>
            <button onclick="window.print()" class="px-4 py-2 bg-gray-800 hover:bg-gray-900 text-white text-sm rounded-md transition flex items-center gap-2 shadow-lg">
                <i class="fa-solid fa-print"></i> Cetak
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar Controls -->
        <aside class="w-1/3 min-w-[320px] max-w-[400px] bg-white border-r border-gray-200 flex flex-col no-print overflow-y-auto">
            <div class="p-5 space-y-6">
                
                <!-- Input Data -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-semibold text-gray-700">Daftar Nama</label>
                        <button onclick="loadSampleData()" class="text-xs text-blue-600 hover:underline">Isi Contoh Data</button>
                    </div>
                    <div class="bg-blue-50 border border-blue-100 p-3 rounded-md mb-2 text-xs text-blue-800">
                        <i class="fa-solid fa-circle-info mr-1"></i> Format: <strong>Nama</strong> atau <strong>Nama, NIS</strong>
                    </div>
                    <textarea id="inputData" class="w-full h-64 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm font-mono" placeholder="Budi Santoso&#10;Siti Aminah, 12345"></textarea>
                    <div class="mt-2 text-right text-xs text-gray-500">
                        Total: <span id="countDisplay">0</span> data
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- Configuration -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Pengaturan Layout</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Orientasi Preview</label>
                            <select id="orientation" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                                <option value="portrait">Portrait</option>
                                <option value="landscape">Landscape</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Jumlah Kolom</label>
                            <input type="number" id="colCount" value="2" min="1" max="6" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Ukuran Font</label>
                            <input type="number" id="fontSizeName" value="24" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="px">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Garis Tepi</label>
                            <select id="borderStyle" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                                <option value="dashed">Putus-putus</option>
                                <option value="solid">Solid</option>
                                <option value="none">Tanpa Garis</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="generateLabels()" class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md shadow-md transition">
                        <i class="fa-solid fa-rotate mr-2"></i> Perbarui Label
                    </button>
                    
                </div>
            </div>
        </aside>

        <!-- Preview Area -->
        <main class="flex-1 bg-gray-100 overflow-auto p-8 relative scroll-smooth" id="main-content">
            <div id="preview-area" class="flex flex-col items-center origin-top">
                <!-- Content will be injected here -->
                <div class="text-center text-gray-400 mt-20">
                    <i class="fa-solid fa-arrow-left text-2xl mb-2"></i>
                    <p>Masukkan data & klik "Perbarui Label"</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let parsedData = [];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('inputData').addEventListener('input', updateCount);
        });

        function updateCount() {
            const text = document.getElementById('inputData').value;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            document.getElementById('countDisplay').innerText = lines.length;
        }

        function loadSampleData() {
            const samples = Array.from({length: 40}, (_, i) => `Siswa Teladan ${i+1}, 2023${String(i+1).padStart(3, '0')}`);
            document.getElementById('inputData').value = samples.join('\n');
            updateCount();
            generateLabels();
        }

        function parseInputData() {
            const rawText = document.getElementById('inputData').value;
            const lines = rawText.split('\n');
            parsedData = [];
            lines.forEach(line => {
                if(line.trim() === '') return;
                let parts = line.includes(',') ? line.split(',') : (line.includes('\t') ? line.split('\t') : [line]);
                const name = parts[0].trim();
                const nis = parts.length > 1 ? parts[1].trim() : '';
                if(name) parsedData.push({ name, nis });
            });
        }

        function generateLabels() {
            parseInputData();
            const container = document.getElementById('preview-area');
            container.innerHTML = ''; 

            if(parsedData.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-20"><p>Tidak ada data.</p></div>`;
                return;
            }

            const colCount = parseInt(document.getElementById('colCount').value) || 2;
            const orientation = document.getElementById('orientation').value;
            const fontSize = document.getElementById('fontSizeName').value;
            const borderStyle = document.getElementById('borderStyle').value;

            // Buat Satu Sheet Panjang (Continuous)
            const sheetDiv = document.createElement('div');
            sheetDiv.className = `sheet ${orientation}`;
            
            const gridDiv = document.createElement('div');
            gridDiv.className = 'label-grid';
            gridDiv.style.gridTemplateColumns = `repeat(${colCount}, 1fr)`;

            parsedData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'label-card';
                if(borderStyle === 'none') card.style.border = 'none';
                else card.style.borderStyle = borderStyle;

                let html = `<div class="label-name" style="font-size: ${fontSize}px">${item.name}</div>`;
                if(item.nis) html += `<div class="label-nis">NIS: ${item.nis}</div>`;
                card.innerHTML = html;
                gridDiv.appendChild(card);
            });

            sheetDiv.appendChild(gridDiv);
            container.appendChild(sheetDiv);
        }

        // --- EXPORT FUNCTIONS ---
        function downloadXLSX() {
            parseInputData();
            if(parsedData.length === 0) return alert("Data kosong!");
            const ws = XLSX.utils.json_to_sheet(parsedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Label");
            XLSX.writeFile(wb, "Label_Nama.xlsx");
        }

        function downloadDOCX() {
            parseInputData();
            if(parsedData.length === 0) return alert("Data kosong!");
            
            // Default ke A4 karena DOCX butuh ukuran halaman
            const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, BorderStyle, TextRun, AlignmentType, PageOrientation } = docx;
            const colCount = parseInt(document.getElementById('colCount').value) || 2;
            const orientation = document.getElementById('orientation').value;
            
            const mmToTwip = 56.69;
            const pW = 210 * mmToTwip;
            const pH = 297 * mmToTwip;

            const doc = new Document({
                sections: [{
                    properties: {
                        page: {
                            size: {
                                width: orientation === 'landscape' ? pH : pW,
                                height: orientation === 'landscape' ? pW : pH,
                                orientation: orientation === 'landscape' ? PageOrientation.LANDSCAPE : PageOrientation.PORTRAIT
                            },
                            margin: { top: 567, bottom: 567, left: 567, right: 567 } 
                        }
                    },
                    children: [
                        new Table({
                            rows: createRowsForDocx(colCount),
                            width: { size: 100, type: WidthType.PERCENTAGE },
                        }),
                    ],
                }],
            });

            Packer.toBlob(doc).then(blob => saveAs(blob, `Label_Nama.docx`));
        }

        function createRowsForDocx(colCount) {
            const { TableRow, TableCell, Paragraph, TextRun, WidthType, BorderStyle, AlignmentType } = docx;
            const rows = [];
            let currentCells = [];
            
            parsedData.forEach((item, index) => {
                const cell = new TableCell({
                    width: { size: 100 / colCount, type: WidthType.PERCENTAGE },
                    margins: { top: 200, bottom: 200, left: 200, right: 200 },
                    borders: {
                        top: { style: BorderStyle.SINGLE, size: 1 },
                        bottom: { style: BorderStyle.SINGLE, size: 1 },
                        left: { style: BorderStyle.SINGLE, size: 1 },
                        right: { style: BorderStyle.SINGLE, size: 1 },
                    },
                    children: [
                        new Paragraph({
                            alignment: AlignmentType.CENTER,
                            children: [new TextRun({ text: item.name, bold: true, size: 28 })], 
                        }),
                        new Paragraph({
                            alignment: AlignmentType.CENTER,
                            children: [new TextRun({ text: item.nis ? item.nis : "", size: 20 })], 
                        }),
                    ],
                });
                currentCells.push(cell);

                if (currentCells.length === colCount || index === parsedData.length - 1) {
                    while(currentCells.length < colCount) {
                        currentCells.push(new TableCell({ width: { size: 100/colCount, type: WidthType.PERCENTAGE }, children: [] }));
                    }
                    rows.push(new TableRow({ children: currentCells }));
                    currentCells = [];
                }
            });
            return rows;
        }
    </script>
</body>
</html>