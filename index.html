<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKWT Label Generator</title>
    <!-- Favicon menggunakan logo SMK Sukawati Sragen -->
    <link rel="icon" type="image/png" sizes="32x32"
        href="https://www.smksukawatisragen.sch.id/media_library/images/276e52d7e3b9ac805b7b6504b56de5b8.png">
    <link rel="icon" type="image/png" sizes="16x16"
        href="https://www.smksukawatisragen.sch.id/media_library/images/276e52d7e3b9ac805b7b6504b56de5b8.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400&display=swap');

        :root {
            --editor-line-height: 24px;
            --editor-font-size: 14px;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
        }

        /* --- EDITOR ENGINE --- */
        .editor-wrapper {
            display: flex;
            flex-direction: row;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            overflow: hidden;
            height: 100%;
            position: relative;
        }

        .editor-wrapper:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Mobile Responsive Sync */
        @media (max-width: 640px) {
            :root {
                --editor-font-size: 10px;
                --editor-line-height: 16px;
            }

            /* Stack header on small screens & CENTER items */
            header .container {
                flex-direction: column;
                gap: 8px;
                align-items: center;
                /* Center Logo */
                padding-bottom: 8px;
            }

            header .container>div {
                width: 100%;
                justify-content: center;
                /* Center Buttons */
                flex-wrap: wrap;
            }
        }

        .line-numbers {
            flex-shrink: 0;
            width: 1.8rem;
            background-color: #f9fafb;
            color: #9ca3af;
            text-align: right;
            border-right: 1px solid #e5e7eb;
            user-select: none;
            overflow: hidden !important;
            white-space: pre;
            font-family: 'JetBrains Mono', monospace;
            font-size: var(--editor-font-size);
            line-height: var(--editor-line-height);
            padding: 8px 4px 24px 0;
            box-sizing: border-box;
        }

        .editor-textarea {
            flex-grow: 1;
            border: none;
            resize: none;
            outline: none;
            white-space: pre;
            overflow-y: scroll;
            font-family: 'JetBrains Mono', monospace;
            font-size: var(--editor-font-size);
            line-height: var(--editor-line-height);
            padding: 8px 4px 24px 4px;
            box-sizing: border-box;
            min-width: 0;
        }

        /* --- PREVIEW --- */
        .sheet {
            background: white;
            margin: 0 auto 30px auto;
            padding: 10mm;
            box-sizing: border-box;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .label-grid {
            display: grid;
            gap: 4mm;
            width: 100%;
        }

        .label-card {
            border: 1px solid #000;
            padding: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            aspect-ratio: 2/1;
            background-color: white;
            break-inside: avoid;
            font-family: 'Arial', sans-serif;
        }

        .label-name {
            line-height: 1.1;
            margin-bottom: 4px;
            color: black;
        }

        .label-nis {
            font-weight: 600;
            color: black;
            letter-spacing: 0.5px;
        }

        /* --- PRINT --- */
        @media print {
            @page {
                size: auto;
                margin: 0;
            }

            body {
                background: white;
                margin: 0;
            }

            #app-ui {
                display: none !important;
            }

            #print-root {
                display: block !important;
            }

            .sheet {
                box-shadow: none !important;
                margin: 0 !important;
                page-break-after: always;
            }

            .sheet:last-child {
                page-break-after: auto;
            }
        }
    </style>
</head>

<body>

    <!-- UI Wrapper -->
    <div id="app-ui" class="flex flex-col min-h-screen">

        <!-- HEADER -->
        <header class="bg-gray-800 text-white sticky top-0 z-50 shadow-md">
            <div class="container mx-auto px-4 py-3 flex sm:flex-row justify-between items-center bg-gray-800">
                <h1 class="text-lg md:text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-tags text-blue-400"></i> SKWT Label
                </h1>
                <div class="flex gap-2 w-full sm:w-auto justify-center sm:justify-end">
                    <!-- NEW SKWT BUTTON -->
                    <a href="https://tuskwt.github.io"
                        class="bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition text-white no-underline">
                        <i class="fa-solid fa-globe"></i> SKWT
                    </a>

                    <button onclick="downloadDOCX()"
                        class="bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition">
                        <i class="fa-solid fa-file-word"></i> Word
                    </button>
                    <button onclick="downloadPDF()"
                        class="bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                    <button onclick="window.print()"
                        class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition">
                        <i class="fa-solid fa-print"></i> Cetak
                    </button>
                </div>
            </div>
        </header>

        <!-- SETTINGS -->
        <section class="bg-gray-100 border-b border-gray-300 py-3 shadow-inner">
            <div class="container mx-auto px-2 md:px-4 space-y-3">
                <!-- Row 1: Layout Config -->
                <div class="grid grid-cols-2 md:flex md:flex-wrap gap-2 items-end">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block uppercase">Ukuran</label>
                        <select id="cfgPaper" onchange="generatePreview()"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-xs font-bold text-gray-800">
                            <option value="F4" selected>F4</option>
                            <option value="A4">A4</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block uppercase">Orientasi</label>
                        <select id="cfgOrient" onchange="generatePreview()"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-xs font-bold text-gray-800">
                            <option value="portrait">Portrait</option>
                            <option value="landscape">Landscape</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block uppercase">Kolom</label>
                        <select id="cfgCols" onchange="generatePreview()"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-xs font-bold text-gray-800">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block uppercase">Garis</label>
                        <select id="cfgBorder" onchange="generatePreview()"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-xs font-bold text-gray-800">
                            <option value="dashed">Putus</option>
                            <option value="solid">Solid</option>
                            <option value="none">None</option>
                        </select>
                    </div>

                    <!-- Actions -->
                    <div class="col-span-2 md:col-span-0 flex gap-2 md:ml-auto">
                        <button onclick="loadSampleData()"
                            class="flex-1 md:flex-none bg-white border border-blue-400 text-blue-600 px-3 py-1.5 rounded text-[10px] font-bold hover:bg-blue-50">
                            <i class="fa-solid fa-magic"></i> Contoh
                        </button>
                        <button onclick="clearData()"
                            class="flex-1 md:flex-none bg-white border border-red-400 text-red-600 px-3 py-1.5 rounded text-[10px] font-bold hover:bg-red-50">
                            <i class="fa-solid fa-trash"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- Row 2: Appearance Config -->
                <div class="grid grid-cols-2 md:flex md:flex-wrap gap-2 items-end border-t pt-2 border-gray-200">
                    <div class="w-full md:w-auto">
                        <label class="text-[10px] font-bold text-gray-500 block uppercase">Font</label>
                        <select id="cfgFont" onchange="generatePreview()"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-xs font-bold text-gray-800">
                            <option value="Arial, sans-serif" selected>Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="'Inter', sans-serif">Inter</option>
                            <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block uppercase">Size Nama</label>
                        <input type="number" id="cfgSizeName" value="26" onchange="generatePreview()"
                            class="w-20 px-2 py-1.5 border border-gray-300 rounded text-xs font-bold text-gray-800">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block uppercase">Size NIS</label>
                        <input type="number" id="cfgSizeNum" value="18" onchange="generatePreview()"
                            class="w-20 px-2 py-1.5 border border-gray-300 rounded text-xs font-bold text-gray-800">
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block uppercase"
                            title="Lebar Label (cm) - Mengubah ini akan mengabaikan kolom">Lebar (cm)</label>
                        <input type="number" id="cfgWidth" min="1" step="0.1" onchange="generatePreview(true)"
                            class="w-20 px-2 py-1.5 border border-gray-300 rounded text-xs font-bold text-gray-800"
                            placeholder="Auto">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block uppercase"
                            title="Tinggi Label (cm)">Tinggi (cm)</label>
                        <input type="number" id="cfgHeight" min="1" step="0.1" onchange="generatePreview(true)"
                            class="w-20 px-2 py-1.5 border border-gray-300 rounded text-xs font-bold text-gray-800"
                            placeholder="Auto">
                    </div>
                </div>
            </div>
        </section>

        <!-- EDITOR -->
        <section class="bg-white py-2 md:py-3">
            <div class="container mx-auto px-2 md:px-4">
                <button onclick="generatePreview()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded font-bold shadow-md mb-3 flex justify-center items-center gap-2 transition active:scale-[0.99] uppercase text-sm">
                    <i class="fa-solid fa-rotate"></i> Update Preview
                </button>

                <!-- 3 Columns forced -->
                <div class="grid grid-cols-3 gap-1 md:gap-4 h-64 md:h-80">
                    <div class="flex flex-col h-full overflow-hidden">
                        <label
                            class="text-[9px] md:text-[10px] font-bold text-gray-500 text-center bg-gray-100 rounded-t py-1 border-x border-t">NAMA</label>
                        <div class="editor-wrapper rounded-t-none">
                            <div id="linesName" class="line-numbers">1</div>
                            <textarea id="inName" class="editor-textarea" placeholder="Nama..."
                                spellcheck="false"></textarea>
                        </div>
                    </div>
                    <div class="flex flex-col h-full overflow-hidden">
                        <label
                            class="text-[9px] md:text-[10px] font-bold text-gray-500 text-center bg-gray-100 rounded-t py-1 border-x border-t">NIS</label>
                        <div class="editor-wrapper rounded-t-none">
                            <div id="linesNIS" class="line-numbers">1</div>
                            <textarea id="inNIS" class="editor-textarea" placeholder="NIS..."
                                spellcheck="false"></textarea>
                        </div>
                    </div>
                    <div class="flex flex-col h-full overflow-hidden">
                        <label
                            class="text-[9px] md:text-[10px] font-bold text-gray-500 text-center bg-gray-100 rounded-t py-1 border-x border-t">NISN</label>
                        <div class="editor-wrapper rounded-t-none">
                            <div id="linesNISN" class="line-numbers">1</div>
                            <textarea id="inNISN" class="editor-textarea" placeholder="NISN..."
                                spellcheck="false"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-[10px] text-gray-400 text-right mt-1">
                    Total Data: <span id="countDisplay">0</span>
                </div>


            </div>
        </section>

        <!-- PREVIEW -->
        <section class="bg-gray-300 flex-grow py-8 min-h-[500px]">
            <div class="container mx-auto px-4 flex flex-col items-center">
                <h2
                    class="text-sm font-bold text-gray-500 mb-4 uppercase tracking-widest bg-white px-2 py-0.5 rounded shadow-sm opacity-60">
                    Result Preview</h2>
                <div id="preview-anchor">
                    <div class="text-center text-gray-500 py-10 opacity-70">
                        <p>Klik tombol <b>UPDATE PREVIEW</b> di atas</p>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- PRINT CONTAINER (Static for Logic) -->
    <div id="print-root" style="display:none;"></div>

    <script>
        // --- STATE ---
        const inputs = {
            name: document.getElementById('inName'),
            nis: document.getElementById('inNIS'),
            nisn: document.getElementById('inNISN')
        };
        const lines = {
            name: document.getElementById('linesName'),
            nis: document.getElementById('linesNIS'),
            nisn: document.getElementById('linesNISN')
        };
        const config = {
            paper: document.getElementById('cfgPaper'),
            orient: document.getElementById('cfgOrient'),
            cols: document.getElementById('cfgCols'),
            border: document.getElementById('cfgBorder'),
            sizeName: document.getElementById('cfgSizeName'),
            sizeNum: document.getElementById('cfgSizeNum'),
            font: document.getElementById('cfgFont'),
            width: document.getElementById('cfgWidth'),
            height: document.getElementById('cfgHeight')
        };

        let parsedData = [];

        // --- EDITOR LOGIC ---
        function updateLines(key) {
            const val = inputs[key].value;
            const count = val.split('\n').length;
            const dispCount = Math.max(count, 50);
            const arr = Array.from({ length: dispCount }, (_, i) => i + 1);
            lines[key].innerHTML = arr.join('\n');
        }
        function syncScroll(key) { lines[key].scrollTop = inputs[key].scrollTop; }
        Object.keys(inputs).forEach(key => {
            const el = inputs[key];
            el.addEventListener('input', () => { updateLines(key); updateCount(); });
            el.addEventListener('scroll', () => syncScroll(key));
            updateLines(key);
        });
        function updateCount() {
            const count = inputs.name.value.trim() ? inputs.name.value.split('\n').length : 0;
            document.getElementById('countDisplay').innerText = count;
        }

        // --- DATA PARSING ---
        function parseData() {
            const rawNames = inputs.name.value.split('\n');
            const rawNIS = inputs.nis.value.split('\n');
            const rawNISN = inputs.nisn.value.split('\n');
            const max = Math.max(rawNames.length, rawNIS.length, rawNISN.length);
            parsedData = [];
            for (let i = 0; i < max; i++) {
                const n = rawNames[i]?.trim();
                const ni = rawNIS[i]?.trim();
                const nn = rawNISN[i]?.trim();
                if (n || ni || nn) parsedData.push({ name: n || '', nis: ni || '', nisn: nn || '' });
            }
        }
        function getBottomText(item) {
            if (item.nis && item.nisn) return `${item.nis} / ${item.nisn}`;
            return item.nis || item.nisn || '';
        }

        // --- GEOMETRIC CALCULATOR ---
        function calculatePageCapacity(forceRecalc = false) {
            const paper = config.paper.value;
            const orient = config.orient.value;
            const cols = parseInt(config.cols.value);
            let pageW = (paper === 'F4') ? 215 : 210;
            let pageH = (paper === 'F4') ? 330 : 297;
            if (orient === 'landscape') { [pageW, pageH] = [pageH, pageW]; }

            const autoCardW = (pageW - 40 - (cols - 1) * 4) / cols;
            const autoCardH = autoCardW / 2;

            let finalW = autoCardW;
            let finalH = autoCardH;

            if (forceRecalc) {
                config.width.value = (autoCardW / 10).toFixed(2);
                config.height.value = (autoCardH / 10).toFixed(2);
            } else {
                if (config.width.value) finalW = parseFloat(config.width.value) * 10;
                if (config.height.value) finalH = parseFloat(config.height.value) * 10;
            }

            const maxRows = Math.floor((pageH - 40 + 4 + 0.1) / (finalH + 4));

            return {
                itemsPerPage: Math.max(1, maxRows) * cols,
                cssWidth: pageW + 'mm',
                cssHeight: pageH + 'mm',
                cardWidth: finalW,
                cardHeight: finalH
            };
        }

        function generatePreview(isManual = false) {
            const activeId = document.activeElement ? document.activeElement.id : '';
            const forceRecalc = ['cfgPaper', 'cfgOrient', 'cfgCols'].includes(activeId);

            parseData();
            const anchor = document.getElementById('preview-anchor');
            anchor.innerHTML = '';
            if (parsedData.length === 0) {
                anchor.innerHTML = '<div class="text-center text-gray-500 py-10 opacity-70"><p>Data Kosong...</p></div>';
                calculatePageCapacity(forceRecalc);
                return;
            }
            const capacity = calculatePageCapacity(forceRecalc);
            const orient = config.orient.value;
            const cols = parseInt(config.cols.value);
            const totalPages = Math.ceil(parsedData.length / capacity.itemsPerPage);

            const fontVal = config.font.value;

            const docFragment = document.createDocumentFragment();
            for (let p = 0; p < totalPages; p++) {
                const sheet = document.createElement('div');
                sheet.className = `sheet ${orient}`;
                sheet.style.width = capacity.cssWidth;
                sheet.style.minHeight = capacity.cssHeight;
                const grid = document.createElement('div');
                grid.className = `label-grid`;
                grid.style.gridTemplateColumns = `repeat(${cols}, max-content)`;
                grid.style.justifyContent = 'space-between';

                parsedData.slice(p * capacity.itemsPerPage, (p + 1) * capacity.itemsPerPage).forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'label-card';
                    card.style.fontFamily = fontVal;
                    card.style.width = `${capacity.cardWidth}mm`;
                    card.style.height = `${capacity.cardHeight}mm`;
                    card.style.padding = '2mm';

                    if (config.border.value === 'none') card.style.border = 'none';
                    else if (config.border.value === 'dashed') card.style.borderStyle = 'dashed';
                    else card.style.borderStyle = 'solid';

                    card.innerHTML = `
                    <div class="label-name" style="font-size: ${config.sizeName.value}px; font-weight:800;">${item.name}</div>
                    <div class="label-nis" style="font-size: ${config.sizeNum.value}px; font-weight:600;">${getBottomText(item)}</div>
                `;
                    grid.appendChild(card);
                });
                sheet.appendChild(grid);
                docFragment.appendChild(sheet);
            }
            anchor.appendChild(docFragment);
            const printRoot = document.getElementById('print-root');
            printRoot.innerHTML = '';
            printRoot.appendChild(anchor.cloneNode(true));
        }

        // --- DOCX DOWNLOAD ---
        function downloadDOCX() {
            parseData();
            if (parsedData.length === 0) return alert("Data Kosong!");

            const activeId = document.activeElement ? document.activeElement.id : '';
            const forceRecalc = ['cfgPaper', 'cfgOrient', 'cfgCols'].includes(activeId);
            const capacity = calculatePageCapacity(forceRecalc);

            const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, BorderStyle, TextRun, AlignmentType, PageOrientation, VerticalAlign } = docx;
            const colCount = parseInt(config.cols.value);
            const orient = config.orient.value;
            const paper = config.paper.value;

            const mmToTwip = 56.6929; // 1mm = 56.7 twips
            let pW = (paper === 'F4' ? 215 : 210) * mmToTwip;
            let pH = (paper === 'F4' ? 330 : 297) * mmToTwip;
            if (orient === 'landscape') [pW, pH] = [pH, pW];

            const rows = [];
            let cells = [];

            // Extract Font Name from value (remove backup fonts)
            // e.g., "Arial, sans-serif" -> "Arial"
            let userFontRaw = config.font.value.split(',')[0].replace(/['"]/g, '').trim();
            const fontFace = userFontRaw || "Arial";

            // Convert Sizes
            // DOCX 'size' is in half-points (1/144 inch).
            // Web px is ~1/96 inch.
            // 1px â‰ˆ 0.75pt.
            // docxSize = px * 0.75 * 2 = px * 1.5.
            const sizeName = Math.round(config.sizeName.value * 1.5);
            const sizeNum = Math.round(config.sizeNum.value * 1.5);

            // Convert Padding to Twips
            const padTwips = Math.round(2 * mmToTwip);

            // Fixed Cell Width based on Label Size
            const cellWidthTwips = capacity.cardWidth * mmToTwip;
            const cellHeightTwips = capacity.cardHeight * mmToTwip;

            parsedData.forEach((item, i) => {
                cells.push(new TableCell({
                    verticalAlign: VerticalAlign.CENTER,
                    margins: { top: padTwips, bottom: padTwips, left: padTwips, right: padTwips },
                    children: [
                        new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: item.name, bold: true, size: sizeName, font: fontFace })] }),
                        new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: getBottomText(item), bold: true, size: sizeNum, font: fontFace })] })
                    ],
                    borders: config.border.value === 'none' ? { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } }
                        : { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                    width: { size: cellWidthTwips, type: WidthType.DXA }
                }));
                if (cells.length === colCount || i === parsedData.length - 1) {
                    while (cells.length < colCount) cells.push(new TableCell({ children: [], width: { size: cellWidthTwips, type: WidthType.DXA } }));
                    rows.push(new TableRow({ children: cells, height: { value: cellHeightTwips, rule: 'exact' } }));
                    cells = [];
                }
            });

            const doc = new Document({
                sections: [{
                    properties: {
                        page: { size: { width: pW, height: pH, orientation: orient === 'landscape' ? PageOrientation.LANDSCAPE : PageOrientation.PORTRAIT }, margin: { top: 10 * mmToTwip, bottom: 10 * mmToTwip, left: 10 * mmToTwip, right: 10 * mmToTwip } }
                    },
                    children: [new Table({ rows: rows })]
                }]
            });

            Packer.toBlob(doc).then(blob => saveAs(blob, `Label_${paper}.docx`));
        }

        // --- PDF DOWNLOAD (BODY SWAP STRATEGY) ---
        function downloadPDF() {
            generatePreview();
            const element = document.getElementById('print-root');
            if (!element.childNodes.length) return alert("Data Kosong!");

            const btn = document.querySelector('button[onclick="downloadPDF()"]');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;

            const appUi = document.getElementById('app-ui');
            appUi.style.display = 'none';

            element.style.display = 'block';
            element.style.background = 'white';
            // RESET MARGINS FOR CAPTURE
            const sheets = element.querySelectorAll('.sheet');
            sheets.forEach((s) => {
                s.style.margin = '0';
                s.style.boxShadow = 'none';
                s.style.marginBottom = '0';
            });

            const paper = config.paper.value;
            const orient = config.orient.value;
            const format = (paper === 'F4') ? [215, 330] : 'a4';

            const opt = {
                margin: 0,
                filename: `Label_${paper}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollX: 0, scrollY: 0 },
                jsPDF: { unit: 'mm', format: format, orientation: orient }
            };

            if (orient === 'landscape') opt.jsPDF.orientation = 'l';

            setTimeout(() => {
                html2pdf().set(opt).from(element).save().then(() => {
                    element.style.display = 'none';
                    appUi.style.display = 'flex';
                    btn.innerHTML = oldText;
                    btn.disabled = false;
                }).catch(err => {
                    console.error(err);
                    alert("Gagal.");
                    element.style.display = 'none';
                    appUi.style.display = 'flex';
                    btn.innerHTML = oldText;
                    btn.disabled = false;
                });
            }, 500);
        }

        // Utils
        function clearData() { if (confirm("Hapus?")) { Object.values(inputs).forEach(el => el.value = ''); Object.keys(inputs).forEach(k => updateLines(k)); generatePreview(); updateCount(); } }
        function loadSampleData() {
            inputs.name.value = "AHMAD FAUZI\nBUDI SANTOSO\nCITRA LESTARI\nDEDI KURNIAWAN\nEKA PUTRI\nFAJAR SIDIK\nGITA GUTAWA\nHADI SUTOYO\nINDRA BEKTI\nJOKO WIDODO\nKARTINI\nLILIS SURYANI\nMAMAN SUHERMAN\nNANA MIRDAD\nOPICK TOMBO ATI\nPUTRI ARIANI\nQUEEN LATIFAH\nRAFFI AHMAD";
            inputs.nis.value = "1001\n1002\n1003\n1004\n1005\n1006\n1007\n1008\n1009\n1010\n1011\n1012\n1013\n1014\n1015\n1016\n1017\n1018";
            inputs.nisn.value = "0012345678\n0012345679\n0012345680\n-\n0012345682\n0012345683\n0012345684\n0012345685\n008\n009\n010\n011\n012\n013\n014\n015\n016\n017";
            Object.keys(inputs).forEach(k => { updateLines(k); inputs[k].scrollTop = 0; });
            generatePreview(); updateCount(); document.getElementById('preview-anchor').scrollIntoView({ behavior: 'smooth' });
        }
        window.addEventListener('beforeprint', generatePreview);
    </script>
</body>

</html>
